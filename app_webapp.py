import os
import uvicorn
import requests
import logging

from fastapi import FastAPI, HTTPException, Body
from src.backend.pydantic_models import ResearchPaperQuery
from src.constants import ENDPOINT_URLS

app = FastAPI(title="Research Assistant API")
logger = logging.getLogger('uvicorn.error')

# Root endpoint just to check if the API is running.
@app.get(ENDPOINT_URLS['web_app']['path'], summary="Root", description="Root endpoint.")
async def root():
    return {"message": "Hello from the AI Research Paper Assistant"}

# Handles research queries.
@app.post(ENDPOINT_URLS['web_app']['additional_paths']['query'], summary="Submit a research query", description="Returns an answer generated by the system.")
async def query_system(query_request:ResearchPaperQuery=Body(...)):
    try:
        
        logger.info("Calling data ingestion endpoint")
        DATA_INGESTION_URL = f"http://{ENDPOINT_URLS['data_ingestion']['base_url']}{ENDPOINT_URLS['data_ingestion']['path']}"
        data_ingestion_result = requests.post(url=DATA_INGESTION_URL, json=query_request.model_dump())
        all_entries = data_ingestion_result.json()["all_entries"]
        logger.info(f"Successfully retrieved {len(all_entries)} entries/documents.")
    
        logger.info("Calling RAG endpoint")
        RAG_URL = f"http://{ENDPOINT_URLS['rag']['base_url']}{ENDPOINT_URLS['rag']['path']}"
        requests.post(url=RAG_URL, json={"message": query_request.message})

        logger.info("Calling LLM inference endpoint")
        LLM_INFERENCE_URL = f"http://{ENDPOINT_URLS['llm_inference']['base_url']}{ENDPOINT_URLS['llm_inference']['path']}"
        requests.post(url=LLM_INFERENCE_URL, json={"prompt": query_request.message})

        logger.info(f"Successfully called the system.")
        # answer = answer_with_rag.invoke(query_request.message)


        return {"answer": None}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
    
if __name__ == "__main__":
    uvicorn.run("app_frontend:app", host="localhost", port=8000, reload=True)
